<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>æ­æ´²æ—…éŠåŠ©æ‰‹</title>
  <style>
    :root {
      --primary-pink: #ffb7b2;
      --soft-blue: #b2e2f2;
      --warm-orange: #ffdac1;
      --bg-color: #fffafb;
      --text-gray: #5d5d5d;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg-color); }
    body { display: flex; flex-direction: column; font-family: -apple-system, "PingFang TC", sans-serif; }

    /* ä¸Šæ–¹å°è¦½åˆ— */
    .nav-header {
      background: #fff;
      padding-top: env(safe-area-inset-top);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 100;
      flex-shrink: 0;
    }
    .tab-bar { display: flex; height: 60px; }
    .tab-item {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 13px; color: #bbb; cursor: pointer; transition: 0.2s; position: relative;
    }
    .tab-item.active { color: var(--primary-pink); font-weight: bold; }
    .tab-item.active::after {
      content: ''; position: absolute; bottom: 0; width: 40%; height: 3px; background: var(--primary-pink); border-radius: 10px;
    }
    .tab-icon { font-size: 20px; margin-bottom: 2px; }

    /* å…§å®¹å€ */
    .content-area { flex: 1; position: relative; overflow: hidden; }
    .page {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      overflow-y: auto; padding: 20px; box-sizing: border-box;
      transition: transform 0.3s ease-out; transform: translateX(100%);
      -webkit-overflow-scrolling: touch;
    }
    .page.active { transform: translateX(0); }
    .page.prev { transform: translateX(-100%); }

    /* å¡ç‰‡èˆ‡è¡¨å–®æ¨£å¼ */
    .card { background: #fff; border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(255,183,178,0.1); }
    label { font-size: 13px; color: #999; margin-bottom: 8px; display: block; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1.5px solid #f0f0f0; border-radius: 12px; font-size: 16px; background: #fafafa; }
    button.btn-save { background: var(--primary-pink); color: white; border: none; border-radius: 15px; padding: 16px; font-size: 17px; font-weight: bold; width: 100%; box-shadow: 0 4px 0 #ff9aa2; cursor: pointer; transition: 0.1s; }
    button.btn-save:active { transform: translateY(2px); box-shadow: 0 2px 0 #ff9aa2; }
    
    /* è¡Œç¨‹å°ˆç”¨æ¨£å¼ */
    .date-divider { color: var(--primary-pink); font-weight: bold; margin: 25px 0 12px; display: flex; align-items: center; font-size: 18px; }
    .date-divider::after { content: ''; flex: 1; height: 1px; background: var(--warm-orange); margin-left: 10px; opacity: 0.5; }
    .itinerary-card { border-left: 5px solid var(--soft-blue); padding-left: 15px; }
    .itinerary-title { font-size: 17px; font-weight: bold; color: var(--text-gray); margin-bottom: 4px; }
    .map-btn { display: inline-flex; align-items: center; background: #f0f7ff; color: #007aff; padding: 8px 14px; border-radius: 12px; font-size: 13px; text-decoration: none; margin-top: 12px; font-weight: 500; border: 1px solid rgba(0,122,255,0.1); }
  </style>
</head>
<body>

  <nav class="nav-header">
    <div class="tab-bar">
      <div class="tab-item active" onclick="switchTab(0)">
        <span class="tab-icon">âœï¸</span><span>è¨˜å¸³</span>
      </div>
      <div class="tab-item" onclick="switchTab(1)">
        <span class="tab-icon">ğŸ’°</span><span>ç´€éŒ„</span>
      </div>
      <div class="tab-item" onclick="switchTab(2)">
        <span class="tab-icon">ğŸ—ºï¸</span><span>è¡Œç¨‹</span>
      </div>
    </div>
  </nav>

  <div class="content-area">
    <div id="page-0" class="page active">
      <div class="card">
        <label>æ—¥æœŸ</label>
        <input type="date" id="addDate">
        
        <label>ä»˜éŒ¢çš„äºº</label>
        <select id="addPerson">
          <option value="U">U</option>
          <option value="ç³">ç³</option>
          <option value="é»‘">é»‘</option>
          <option value="ä¸¹">ä¸¹</option>
        </select>

        <label>é …ç›®åç¨±</label>
        <input type="text" id="addItem" placeholder="ä¾‹å¦‚ï¼šç”±å¸ƒé™¢ä¹‹æ£®è»Šç¥¨">
        
        <div style="display:flex; gap:12px;">
          <div style="flex:1">
            <label>åˆ†é¡</label>
            <select id="addCategory">
              <option>åƒ ğŸ•</option>
              <option>äº¤é€š ğŸ«</option>
              <option>ä½å®¿ ğŸ¨</option>
              <option>è³¼ç‰© ğŸ›ï¸</option>
              <option>å…¶ä»– âœ¨</option>
            </select>
          </div>
          <div style="flex:1">
            <label>é‡‘é¡</label>
            <input type="number" id="addAmount" placeholder="0.00" inputmode="decimal">
          </div>
        </div>
        
        <button class="btn-save" onclick="submitExpense()">å„²å­˜è¨˜å¸³</button>
        <div id="status-msg" style="text-align:center; margin-top:12px; font-size:13px; color:var(--primary-pink); min-height: 1.2em;"></div>
      </div>
    </div>

    <div id="page-1" class="page">
      <div id="history-content">è¼‰å…¥ä¸­...</div>
    </div>

    <div id="page-2" class="page">
      <div id="itinerary-content">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

<script>
  // åŸºç¤è¨­å®š
  const SPREADSHEET_ID = "1-bY7b7pZpFN8ANpTkRKSzQ2FARgy0KYPkEMaqU7CVIk";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwE9dQuZ0TlCyW4d-FaybzNs-muTqUAuBCbML2ETJyurBpGs0yN0JsGPhqaoc8ILCUj/exec"; 

  // åˆå§‹åŒ–æ—¥æœŸ
  document.getElementById('addDate').valueAsDate = new Date();

  // é ç±¤åˆ‡æ›
  function switchTab(index) {
    const pages = document.querySelectorAll('.page');
    const tabs = document.querySelectorAll('.tab-item');
    pages.forEach((p, i) => {
      p.classList.remove('active', 'prev');
      if(i === index) p.classList.add('active');
      else if(i < index) p.classList.add('prev');
    });
    tabs.forEach((t, i) => t.classList.toggle('active', i === index));
    
    if(index === 1) loadData('è¨˜å¸³', renderHistory);
    if(index === 2) loadData('è¡Œç¨‹', renderItinerary);
  }

  // å¾ Google Sheet æŠ“å– CSV è³‡æ–™
  async function loadData(sheetName, callback) {
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    try {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      callback(parseCSV(text));
    } catch (e) { 
      console.error(e);
      document.getElementById(sheetName === 'è¨˜å¸³' ? 'history-content' : 'itinerary-content').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
    }
  }

  // CSV è§£æå™¨ (è™•ç†é€—è™Ÿèˆ‡å¼•è™Ÿ)
  function parseCSV(text) {
    const lines = text.split("\n").filter(l => l.trim());
    if (!lines.length) return [];
    const header = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
    return lines.slice(1).map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const obj = {};
      header.forEach((h, i) => obj[h] = cols[i]?.replace(/"/g, "").trim());
      return obj;
    });
  }

  // æ¸²æŸ“è¨˜å¸³æ­·å²
  function renderHistory(data) {
    const container = document.getElementById('history-content');
    let total = 0;
    const html = data.reverse().map(r => {
      const amt = parseFloat(r["é‡‘é¡"] || 0);
      total += amt;
      return `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="text-align:left">
          <b style="color:var(--text-gray)">${r["é …ç›®"] || "æœªå‘½å"}</b> <small style="color:var(--primary-pink)">(${r["äºº"]})</small><br>
          <small style="color:#aaa">${r["æ—¥æœŸ"]} Â· ${r["åˆ†é¡"]}</small>
        </div>
        <div style="color:var(--primary-pink); font-weight:bold; font-size:18px;">$${amt.toFixed(2)}</div>
      </div>`;
    }).join("");

    container.innerHTML = `
      <div class="card" style="background:linear-gradient(135deg, var(--primary-pink), var(--warm-orange)); color:#fff; text-align:center; border:none;">
        <div style="font-size:13px; opacity:0.9">ç›®å‰ç¸½æ”¯å‡º</div>
        <div style="font-size:28px; font-weight:bold;">$${total.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
      </div>` + html;
  }

  // æ¸²æŸ“è¡Œç¨‹ (é€£å‹• Day, æ—¥æœŸ, æ™‚é–“, æ¨™é¡Œ, å…§å®¹, Google map)
  function renderItinerary(data) {
    const container = document.getElementById('itinerary-content');
    let currentDayLabel = "";
    let html = "";

    if (!data || data.length === 0) {
      container.innerHTML = '<div class="card">ğŸ“­ ç›®å‰é‚„æ²’æœ‰è¡Œç¨‹è¦åŠƒå–”</div>';
      return;
    }

    data.forEach(r => {
      // é€£å‹• Day (Aæ¬„) èˆ‡ æ—¥æœŸ (Bæ¬„) åšåˆ†éš”æ¨™è¨˜
      const day = r["Day"] || "";
      const date = r["æ—¥æœŸ"] || "";
      const time = r["æ™‚é–“"] || "";
      const title = r["æ¨™é¡Œ"] || "";
      const content = r["å…§å®¹"] || "";
      const mapKey = r["Google map"] || "";

      if (day && day !== currentDayLabel) {
        currentDayLabel = day;
        html += `<div class="date-divider">${day} <span style="font-size:14px; font-weight:normal; margin-left:8px; opacity:0.7;">${date}</span></div>`;
      }

      html += `
        <div class="card itinerary-card">
          ${time ? `<div style="font-size:12px; color:var(--soft-blue); font-weight:bold; margin-bottom:4px;">â° ${time}</div>` : ''}
          <div class="itinerary-title">${title}</div>
          ${content ? `<div style="font-size:14px; color:#888; white-space:pre-wrap; margin-top:6px; line-height:1.5;">${content}</div>` : ''}
          ${mapKey ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapKey)}" target="_blank" class="map-btn">ğŸ“ åœ°åœ–å°èˆªï¼š${mapKey}</a>` : ''}
        </div>`;
    });
    container.innerHTML = html;
  }

  // æäº¤è¨˜å¸³è³‡æ–™
  async function submitExpense() {
    const btn = document.querySelector('.btn-save');
    const status = document.getElementById('status-msg');
    
    const date = document.getElementById('addDate').value;
    const person = document.getElementById('addPerson').value;
    const item = document.getElementById('addItem').value;
    const category = document.getElementById('addCategory').value;
    const amount = document.getElementById('addAmount').value;

    if(!item || !amount) { alert("è«‹å¡«å¯«é …ç›®èˆ‡é‡‘é¡"); return; }
    
    btn.disabled = true;
    status.innerText = "ğŸš€ å‚³é€ä¸­...";

    const params = new URLSearchParams();
    params.append('date', date);
    params.append('person', person);
    params.append('item', item);
    params.append('category', category);
    params.append('amount', amount);

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors", 
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params.toString()
      });

      status.innerText = "âœ… å„²å­˜æˆåŠŸï¼";
      document.getElementById('addItem').value = "";
      document.getElementById('addAmount').value = "";
      
      setTimeout(() => { 
        status.innerText = ""; 
        switchTab(1); 
      }, 1000);
      
    } catch(e) {
      console.error(e);
      status.innerText = "âŒ å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š";
    } finally {
      btn.disabled = false;
    }
  }
</script>
</body>
</html>
