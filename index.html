<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>æ­æ´²å°é¹¿æ—…éŠåŠ©æ‰‹</title>
  <style>
    :root {
      --primary-pink: #ffb7b2;
      --soft-blue: #b2e2f2;
      --warm-orange: #ffdac1;
      --bg-color: #fffafb;
      --text-gray: #5d5d5d;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: var(--bg-color);
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: -apple-system, "PingFang TC", sans-serif;
    }

    /* é ‚éƒ¨å°è¦½åˆ—ï¼šç§»å‹•åˆ°é€™è£¡ */
    .nav-header {
      background: #fff;
      padding-top: env(safe-area-inset-top); /* é¿é–‹ç€æµ·å€ */
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 100;
      flex-shrink: 0;
    }

    .tab-bar {
      display: flex;
      justify-content: space-around;
      align-items: center;
      height: 60px;
    }

    .tab-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #bbb;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .tab-item.active {
      color: var(--primary-pink);
      font-weight: bold;
    }

    /* åº•ç·šå‹•ç•«æ•ˆæœ */
    .tab-item.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      width: 40%;
      height: 3px;
      background: var(--primary-pink);
      border-radius: 10px;
    }

    .tab-icon { font-size: 20px; margin-bottom: 2px; }

    /* å…§å®¹å€ */
    .content-area { 
      flex: 1; 
      position: relative; 
      overflow: hidden;
    }

    .page {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      overflow-y: auto; padding: 20px; box-sizing: border-box;
      transition: transform 0.3s ease-out; 
      transform: translateX(100%);
      -webkit-overflow-scrolling: touch;
    }
    .page.active { transform: translateX(0); }
    .page.prev { transform: translateX(-100%); }

    /* å¯æ„›å¡ç‰‡ */
    .card { background: #fff; border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(255,183,178,0.1); }
    label { font-size: 13px; color: #999; margin-bottom: 8px; display: block; font-weight: 500; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1.5px solid #f0f0f0; border-radius: 12px; font-size: 16px; background: #fafafa; }
    input:focus { border-color: var(--primary-pink); outline: none; background: #fff; }
    
    button.btn-save { 
      background: var(--primary-pink); color: white; border: none; border-radius: 15px; 
      padding: 16px; font-size: 17px; font-weight: bold; width: 100%; 
      box-shadow: 0 4px 0 #ff9aa2; transition: all 0.1s;
    }
    button.btn-save:active { transform: translateY(2px); box-shadow: 0 2px 0 #ff9aa2; }

    /* è¡Œç¨‹æ¸…å–® */
    .itinerary-item { border-left: 2px dashed var(--soft-blue); margin-left: 10px; padding-left: 20px; position: relative; margin-bottom: 25px; text-align: left; }
    .itinerary-item::before { content: 'ğŸ“'; position: absolute; left: -12px; top: 0; background: var(--bg-color); font-size: 14px; }
  </style>
</head>
<body>

  <nav class="nav-header">
    <div class="tab-bar">
      <div class="tab-item active" id="tab-0" onclick="switchTab(0, 'ğŸ“ æ–°å¢è¨˜å¸³')">
        <span class="tab-icon">âœï¸</span><span>è¨˜å¸³</span>
      </div>
      <div class="tab-item" id="tab-1" onclick="switchTab(1, 'ğŸ“… è¨˜å¸³æ­·å²')">
        <span class="tab-icon">ğŸ’°</span><span>ç´€éŒ„</span>
      </div>
      <div class="tab-item" id="tab-2" onclick="switchTab(2, 'âœˆï¸ è¡Œç¨‹è¦åŠƒ')">
        <span class="tab-icon">ğŸ—ºï¸</span><span>è¡Œç¨‹</span>
      </div>
    </div>
  </nav>

  <div class="content-area">
    <div id="page-add" class="page active">
      <div class="card">
        <label>æ—¥æœŸ</label>
        <input type="date" id="addDate">
        <label>é …ç›®åç¨±</label>
        <input type="text" id="addItem" placeholder="ä¾‹å¦‚ï¼šæ³•åœ‹ç‰›è§’éºµåŒ…">
        <div style="display:flex; gap:12px;">
          <div style="flex:1">
            <label>é‡‘é¡(EUR)</label>
            <input type="number" id="addAmount" placeholder="0.00" inputmode="decimal">
          </div>
          <div style="flex:1">
            <label>åˆ†é¡</label>
            <select id="addCategory">
              <option>åƒ ğŸ•</option>
              <option>äº¤é€š ğŸ«</option>
              <option>ä½å®¿ ğŸ¨</option>
              <option>è³¼ç‰© ğŸ›ï¸</option>
              <option>å…¶ä»– âœ¨</option>
            </select>
          </div>
        </div>
        <button class="btn-save" onclick="submitExpense()">å„²å­˜é€™ç­†èŠ±è²»</button>
        <div id="status-msg" style="text-align:center; margin-top:12px; font-size:13px; color:var(--primary-pink); min-height: 20px;"></div>
      </div>
    </div>

    <div id="page-list" class="page">
      <div id="history-content">è¼‰å…¥ç´€éŒ„ä¸­...</div>
    </div>

    <div id="page-travel" class="page">
      <div id="itinerary-content">æ­£åœ¨ç¿»é–±è¡Œç¨‹è¡¨...</div>
    </div>
  </div>

<script>
  // åŸºç¤è¨­å®š
  const SPREADSHEET_ID = "1-bY7b7pZpFN8ANpTkRKSzQ2FARgy0KYPkEMaqU7CVIk";
  const GAS_URL = "æ‚¨çš„GASéƒ¨ç½²ç¶²å€"; 
  const EUR_TO_TWD = 34.5;

  // åˆå§‹åŒ–æ—¥æœŸ
  document.getElementById('addDate').valueAsDate = new Date();

  // åˆ‡æ›åˆ†é é‚è¼¯
  function switchTab(index) {
    const pages = document.querySelectorAll('.page');
    const tabs = document.querySelectorAll('.tab-item');
    
    pages.forEach((p, i) => {
      p.classList.remove('active', 'prev');
      if(i === index) p.classList.add('active');
      else if(i < index) p.classList.add('prev');
    });
    
    tabs.forEach((t, i) => {
      t.classList.toggle('active', i === index);
    });
    
    if(index === 1) loadData('æ­æ´²è¨˜å¸³è¡Œç¨‹/è¨˜å¸³', renderHistory);
    if(index === 2) loadData('è¡Œç¨‹', renderItinerary);
  }

  // è®€å– CSV
  async function loadData(sheetName, callback) {
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error();
      const text = await res.text();
      callback(parseCSV(text));
    } catch (e) { 
      const content = sheetName === 'è¡Œç¨‹' ? 'itinerary-content' : 'history-content';
      document.getElementById(content).innerText = "è®€å–ä¸åˆ°è³‡æ–™ï¼Œè«‹ç¢ºèªè©¦ç®—è¡¨å·²ç™¼ä½ˆã€‚"; 
    }
  }

  function parseCSV(text) {
    const lines = text.split("\n").filter(l => l.trim());
    if (lines.length === 0) return [];
    const header = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
    return lines.slice(1).map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const obj = {};
      header.forEach((h, i) => obj[h] = cols[i]?.replace(/"/g, "").trim());
      return obj;
    });
  }

  function renderHistory(data) {
    const container = document.getElementById('history-content');
    let total = 0;
    const html = data.reverse().map(r => {
      const amt = Number(r["é‡‘é¡(EUR)"] || r["EUR"] || 0);
      total += amt;
      return `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="text-align:left"><b>${r["é …ç›®"] || 'æœªå‘½å'}</b><br><small style="color:#aaa">${r["æ—¥æœŸ"]} Â· ${r["åˆ†é¡"]}</small></div>
        <div style="color:var(--primary-pink); font-weight:bold;">â‚¬${amt.toFixed(2)}</div>
      </div>`;
    }).join("");
    container.innerHTML = `<div class="card" style="background:var(--warm-orange); color:#fff; text-align:center; border:none; margin-bottom:20px;">
      <div style="font-size:12px; opacity:0.9">ç¸½æ”¯å‡ºç´¯è¨ˆ</div>
      <div style="font-size:22px; font-weight:bold; margin:4px 0;">â‚¬${total.toFixed(2)}</div>
      <div style="font-size:14px; opacity:0.9">ç´„ NT$ ${Math.round(total*EUR_TO_TWD).toLocaleString()}</div>
    </div>` + html;
  }

  function renderItinerary(data) {
    const container = document.getElementById('itinerary-content');
    const html = data.map(r => `
      <div class="itinerary-item">
        <div style="font-size: 12px; color: var(--soft-blue); font-weight: bold;">${r["æ™‚é–“"] || 'å…¨å¤©'}</div>
        <div style="font-weight: bold; font-size: 16px; margin: 4px 0; color:var(--text-gray);">${r["åœ°é»"]}</div>
        <div style="font-size:14px; color:#888;">${r["æ´»å‹•å…§å®¹"] || ''}</div>
        ${r["å‚™è¨»"] ? `<div style="font-size:12px; color:#bbb; margin-top:4px; background:#f9f9f9; padding:4px 8px; border-radius:6px; display:inline-block;">ğŸ’¡ ${r["å‚™è¨»"]}</div>` : ''}
      </div>
    `).join("");
    container.innerHTML = html || '<div class="card">è¡Œç¨‹è¡¨ç›®å‰æ˜¯ç©ºçš„å”·ï¼</div>';
  }

  async function submitExpense() {
    const btn = document.querySelector('.btn-save');
    const status = document.getElementById('status-msg');
    const itemInput = document.getElementById('addItem');
    const amtInput = document.getElementById('addAmount');

    const data = {
      date: document.getElementById('addDate').value,
      person: "Ula",
      item: itemInput.value,
      category: document.getElementById('addCategory').value,
      amount: amtInput.value,
      note: ""
    };

    if(!data.item || !data.amount) { alert("é …ç›®å’Œé‡‘é¡éƒ½è¦å¡«å¯«å–”ï¼"); return; }
    
    btn.disabled = true;
    status.innerText = "ğŸš€ å‚³é€ä¸­...";

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(data)
      });
      status.innerText = "âœ… è¨˜å¸³æˆåŠŸï¼";
      itemInput.value = "";
      amtInput.value = "";
      setTimeout(() => { status.innerText = ""; }, 3000);
    } catch(e) {
      status.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
    } finally {
      btn.disabled = false;
    }
  }
</script>
</body>
</html>
