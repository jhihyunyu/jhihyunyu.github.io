<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>歐洲旅遊記帳 V2</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif; margin: 20px; background: #f5f5f7; }
    h1 { margin: 0 0 8px; }
    .sub { color: #555; margin-bottom: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: stretch; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .card strong { display:block; font-size: 24px; margin-top: 4px; color: #111; }
    label { font-size: 12px; color:#666; display:block; margin-bottom: 6px; font-weight: bold; }
    select, input { padding: 10px; border: 1px solid #ccc; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    button { padding: 12px 14px; border: none; background:#111; color:#fff; border-radius: 10px; cursor:pointer; width: 100%; font-weight: bold; }
    button:disabled { background: #ccc; }
    button.secondary { background:#fff; color:#111; border: 1px solid #ccc; }
    
    /* 新增帳務表單專用 */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .full-width { grid-column: span 2; }
    
    table { width:100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 12px; overflow: hidden; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align:left; }
    th { background: #fafafa; font-size: 14px; color: #666; }
    .err { color: #b00020; padding: 10px; background: #fee; border-radius: 8px; margin: 10px 0; display: none; }
    .success-msg { color: #2e7d32; font-size: 12px; margin-top: 5px; }
  </style>
</head>

<body>
  <h1>歐洲旅遊記帳</h1>
  <div class="sub">即時記帳並同步至 Google Sheets</div>

  <div class="row">
    <div class="card" style="flex: 1; min-width: 300px;">
      <label style="font-size: 16px; color: #111; margin-bottom: 15px;">➕ 新增支出</label>
      <div id="formError" class="err"></div>
      <div class="form-grid">
        <div>
          <label>日期</label>
          <input type="date" id="addDate">
        </div>
        <div>
          <label>付款人</label>
          <select id="addPerson">
            <option value="Ula">Ula</option>
            <option value="Partner">伙伴</option>
          </select>
        </div>
        <div class="full-width">
          <label>項目名稱</label>
          <input type="text" id="addItem" placeholder="例如：由布院之森火車票">
        </div>
        <div>
          <label>分類</label>
          <select id="addCategory">
            <option value="吃">吃</option>
            <option value="交通">交通</option>
            <option value="住宿">住宿</option>
            <option value="購物">購物</option>
            <option value="其他">其他</option>
          </select>
        </div>
        <div>
          <label>金額 (EUR)</label>
          <input type="number" id="addAmount" step="0.01" placeholder="0.00">
        </div>
        <div class="full-width">
          <label>備註</label>
          <input type="text" id="addNote" placeholder="選填">
        </div>
      </div>
      <button id="btnSubmit">確認送出記帳</button>
      <div id="submitStatus" class="success-msg"></div>
    </div>

    <div class="card" style="width: 250px;">
      <div class="muted">總支出（EUR）</div>
      <strong id="sumEur">-</strong>
      <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">
      <div class="muted">總支出（TWD）</div>
      <strong id="sumTwd">-</strong>
      <div class="muted" style="font-size: 12px; margin-top: 5px;">匯率：34.5</div>
      
      <div style="margin-top: 20px;">
        <label>快速篩選分類</label>
        <select id="filterCategory">
          <option value="">全部顯示</option>
          <option value="吃">吃</option>
          <option value="交通">交通</option>
          <option value="住宿">住宿</option>
          <option value="購物">購物</option>
        </select>
        <button class="secondary" id="btnRefresh" style="margin-top: 10px;">整理/刷新資料</button>
      </div>
    </div>
  </div>

  <div id="status" style="margin-top: 20px; font-size: 14px; color: #666;">載入中...</div>

  <table>
    <thead>
      <tr>
        <th>日期</th>
        <th>人</th>
        <th>項目</th>
        <th>分類</th>
        <th>金額(EUR)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

<script>
  // === 設定區 ===
  // 1. 這是你原本的 Sheet ID
  const SPREADSHEET_ID = "1-bY7b7pZpFN8ANpTkRKSzQ2FARgy0KYPkEMaqU7CVIk";
  // 2. 這是你的 GAS Web App URL (完成第二步後填入)
  const GAS_WEB_APP_URL = "你的_GAS_部署網址"; 
  
  const SHEET_NAME = "歐洲記帳行程/記帳";
  const EUR_TO_TWD = 34.5;

  // 初始化日期為今天
  document.getElementById('addDate').valueAsDate = new Date();

  let rows = [];

  // --- 讀取資料 ---
  async function loadData() {
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;
    try {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      rows = parseCSV(text);
      renderTable(rows);
      calculateSum(rows);
      document.getElementById('status').textContent = `最後更新：${new Date().toLocaleTimeString()}`;
    } catch (e) {
      console.error(e);
    }
  }

  // --- 送出資料 ---
  document.getElementById('btnSubmit').addEventListener('click', async () => {
    const btn = document.getElementById('btnSubmit');
    const status = document.getElementById('submitStatus');
    
    const data = {
      date: document.getElementById('addDate').value,
      person: document.getElementById('addPerson').value,
      item: document.getElementById('addItem').value,
      category: document.getElementById('addCategory').value,
      amount: document.getElementById('addAmount').value,
      note: document.getElementById('addNote').value
    };

    if (!data.item || !data.amount) {
      alert("請填寫項目與金額");
      return;
    }

    btn.disabled = true;
    status.textContent = "傳送中...";

    try {
      // 這裡使用 GAS 處理寫入
      await fetch(GAS_WEB_APP_URL, {
        method: "POST",
        mode: "no-cors", // 重要：跨網域處理
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      });
      
      status.textContent = "✅ 成功寫入 Google Sheets！";
      document.getElementById('addItem').value = "";
      document.getElementById('addAmount').value = "";
      
      // 延遲一下後重新載入列表
      setTimeout(loadData, 2000);
    } catch (e) {
      status.textContent = "❌ 發生錯誤，請檢查 GAS 設定";
    } finally {
      btn.disabled = false;
    }
  });

  // (其餘輔助函式：parseCSV, renderTable, calculateSum 與你原本的雷同但簡化以維持效能)
  function parseCSV(text) {
    const lines = text.split("\n").filter(l => l.trim());
    const header = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
    return lines.slice(1).map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // 處理 CSV 逗號
      const obj = {};
      header.forEach((h, i) => obj[h] = cols[i]?.replace(/"/g, "").trim());
      return obj;
    });
  }

  function renderTable(data) {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = data.map(r => `
      <tr>
        <td>${r["日期"] || ''}</td>
        <td>${r["人"] || ''}</td>
        <td>${r["項目"] || ''}</td>
        <td>${r["分類"] || ''}</td>
        <td>${r["金額(EUR)"] || r["EUR"] || 0}</td>
      </tr>
    `).reverse().slice(0, 20).join(""); // 顯示最新20筆
  }

  function calculateSum(data) {
    const total = data.reduce((acc, r) => acc + Number(r["金額(EUR)"] || r["EUR"] || 0), 0);
    document.getElementById("sumEur").textContent = total.toFixed(2);
    document.getElementById("sumTwd").textContent = Math.round(total * EUR_TO_TWD).toLocaleString();
  }

  document.getElementById('btnRefresh').onclick = loadData;
  loadData();
</script>
</body>
</html>
