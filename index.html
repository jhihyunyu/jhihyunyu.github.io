<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>æ­æ´²å°é¹¿æ—…éŠåŠ©æ‰‹</title>
  <style>
    :root {
      --primary-pink: #ffb7b2;
      --soft-blue: #b2e2f2;
      --warm-orange: #ffdac1;
      --bg-color: #fffafb;
      --text-gray: #5d5d5d;
    }

    /* ä¿®æ­£æ‰‹æ©Ÿé«˜åº¦å•é¡Œ */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: var(--bg-color);
    }

    body {
      display: flex;
      flex-direction: column;
      font-family: -apple-system, "PingFang TC", sans-serif;
    }

    .header { 
      text-align: center; padding: 15px; font-weight: bold; font-size: 18px; 
      background: #fff; color: var(--primary-pink); 
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      flex-shrink: 0;
    }

    /* å…§å®¹å€ */
    .content-area { 
      flex: 1; 
      position: relative; 
      overflow: hidden;
    }

    .page {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      overflow-y: auto; padding: 20px; box-sizing: border-box;
      transition: transform 0.3s ease; transform: translateX(100%);
      -webkit-overflow-scrolling: touch; /* æµæš¢æ»¾å‹• */
    }
    .page.active { transform: translateX(0); }
    .page.prev { transform: translateX(-100%); }

    /* å¯æ„›å¡ç‰‡èˆ‡å…ƒä»¶ */
    .card { background: #fff; border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
    label { font-size: 13px; color: #999; margin-bottom: 5px; display: block; }
    input, select { width: 100%; padding: 12px; margin-bottom: 12px; border: 1.5px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #fff; }
    button.btn-save { background: var(--primary-pink); color: white; border: none; border-radius: 15px; padding: 15px; font-size: 17px; font-weight: bold; width: 100%; }

    /* åº•éƒ¨å°è¦½åˆ— - æ ¸å¿ƒä¿®å¾©å€ */
    .tab-bar {
      flex-shrink: 0;
      display: flex; 
      background: #fff; 
      border-top: 1px solid #eee;
      padding-bottom: env(safe-area-inset-bottom); /* é¿é–‹ iPhone åº•éƒ¨ç™½æ¢ */
      height: calc(70px + env(safe-area-inset-bottom));
      box-shadow: 0 -2px 10px rgba(0,0,0,0.03);
    }
    .tab-item { 
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; 
      font-size: 12px; color: #bbb; text-decoration: none; border: none; background: none;
    }
    .tab-item.active { color: var(--primary-pink); font-weight: bold; }
    .tab-icon { font-size: 24px; margin-bottom: 2px; }

    /* è¡Œç¨‹æ¸…å–® */
    .itinerary-item { border-left: 2px dashed var(--soft-blue); margin-left: 10px; padding-left: 20px; position: relative; margin-bottom: 20px; text-align: left;}
    .itinerary-item::before { content: 'ğŸ“'; position: absolute; left: -12px; top: 0; background: var(--bg-color); }
  </style>
</head>
<body>

  <div class="header" id="page-title">ğŸ“ æ–°å¢è¨˜å¸³</div>

  <div class="content-area">
    <div id="page-add" class="page active">
      <div class="card">
        <label>æ—¥æœŸ</label>
        <input type="date" id="addDate">
        <label>é …ç›®</label>
        <input type="text" id="addItem" placeholder="åƒä»€éº¼æˆ–è²·ä»€éº¼ï¼Ÿ">
        <div style="display:flex; gap:10px;">
          <div style="flex:1"><label>é‡‘é¡(EUR)</label><input type="number" id="addAmount" placeholder="0.00" inputmode="decimal"></div>
          <div style="flex:1"><label>åˆ†é¡</label>
            <select id="addCategory">
              <option>åƒ ğŸ•</option><option>äº¤é€š ğŸ«</option><option>ä½å®¿ ğŸ¨</option><option>è³¼ç‰© ğŸ›ï¸</option><option>å…¶ä»– âœ¨</option>
            </select>
          </div>
        </div>
        <button class="btn-save" onclick="submitExpense()">å„²å­˜é€™ç­†èŠ±è²»</button>
        <div id="status-msg" style="text-align:center; margin-top:10px; font-size:12px; color:var(--primary-pink)"></div>
      </div>
    </div>

    <div id="page-list" class="page">
      <div id="history-content">è¼‰å…¥ç´€éŒ„ä¸­...</div>
    </div>

    <div id="page-travel" class="page">
      <div id="itinerary-content">æ­£åœ¨ç¿»é–±è¡Œç¨‹è¡¨...</div>
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab-item active" id="tab-0" onclick="switchTab(0, 'ğŸ“ æ–°å¢è¨˜å¸³')">
      <span class="tab-icon">âœï¸</span><span>è¨˜å¸³</span>
    </div>
    <div class="tab-item" id="tab-1" onclick="switchTab(1, 'ğŸ“… è¨˜å¸³æ­·å²')">
      <span class="tab-icon">ğŸ’°</span><span>ç´€éŒ„</span>
    </div>
    <div class="tab-item" id="tab-2" onclick="switchTab(2, 'âœˆï¸ è¡Œç¨‹è¦åŠƒ')">
      <span class="tab-icon">ğŸ—ºï¸</span><span>è¡Œç¨‹</span>
    </div>
  </div>

<script>
  // è«‹è¨˜å¾—å¡«å¯«æ‚¨çš„è¨­å®š
  const SPREADSHEET_ID = "1-bY7b7pZpFN8ANpTkRKSzQ2FARgy0KYPkEMaqU7CVIk";
  const GAS_URL = "æ‚¨çš„GASéƒ¨ç½²ç¶²å€"; 
  const EUR_TO_TWD = 34.5;

  document.getElementById('addDate').valueAsDate = new Date();

  function switchTab(index, title) {
    const pages = document.querySelectorAll('.page');
    const tabs = document.querySelectorAll('.tab-item');
    document.getElementById('page-title').innerText = title;
    
    pages.forEach((p, i) => {
      p.classList.remove('active', 'prev');
      if(i === index) p.classList.add('active');
      else if(i < index) p.classList.add('prev');
    });
    
    tabs.forEach((t, i) => t.classList.toggle('active', i === `tab-${index}`));
    // ä¿®æ­£é¸å–æ¨£å¼
    document.querySelectorAll('.tab-item').forEach((t, i) => {
      t.classList.toggle('active', i === index);
    });
    
    if(index === 1) loadData('æ­æ´²è¨˜å¸³è¡Œç¨‹/è¨˜å¸³', renderHistory);
    if(index === 2) loadData('è¡Œç¨‹', renderItinerary);
  }

  // è®€å– CSV çš„å‡½å¼ (èˆ‡ä¹‹å‰ç›¸åŒï¼Œä½†ç¢ºä¿æ›´æ–°)
  async function loadData(sheetName, callback) {
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    try {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      callback(parseCSV(text));
    } catch (e) { document.getElementById('history-content').innerText = "è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèª Sheets ç™¼ä½ˆç‹€æ…‹"; }
  }

  function parseCSV(text) {
    const lines = text.split("\n").filter(l => l.trim());
    const header = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
    return lines.slice(1).map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const obj = {};
      header.forEach((h, i) => obj[h] = cols[i]?.replace(/"/g, "").trim());
      return obj;
    });
  }

  function renderHistory(data) {
    const container = document.getElementById('history-content');
    let total = 0;
    const html = data.reverse().map(r => {
      const amt = Number(r["é‡‘é¡(EUR)"] || r["EUR"] || 0);
      total += amt;
      return `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="text-align:left"><b>${r["é …ç›®"]}</b><br><small>${r["æ—¥æœŸ"]} Â· ${r["åˆ†é¡"]}</small></div>
        <div style="color:var(--primary-pink); font-weight:bold;">â‚¬${amt}</div>
      </div>`;
    }).join("");
    container.innerHTML = `<div class="card" style="background:var(--warm-orange); color:#fff; text-align:center; border:none;">
      <small>ç›®å‰ç¸½æ”¯å‡º</small><br><b style="font-size:20px;">â‚¬${total.toFixed(2)} / NT$${Math.round(total*EUR_TO_TWD).toLocaleString()}</b>
    </div>` + html;
  }

  function renderItinerary(data) {
    const container = document.getElementById('itinerary-content');
    container.innerHTML = data.map(r => `
      <div class="itinerary-item">
        <div style="font-size: 12px; color: var(--soft-blue); font-weight: bold;">${r["æ™‚é–“"] || 'å…¨å¤©'}</div>
        <div style="font-weight: bold; font-size: 16px; margin: 4px 0;">${r["åœ°é»"]}</div>
        <div style="font-size:14px; color:#777;">${r["æ´»å‹•å…§å®¹"] || ''}</div>
        <div style="font-size:12px; color:#bbb; margin-top:4px;">${r["å‚™è¨»"] || ''}</div>
      </div>
    `).join("") || "è¡Œç¨‹è¡¨ç›®å‰æ²’æœ‰å…§å®¹å–”ï¼";
  }

  async function submitExpense() {
    const btn = document.querySelector('.btn-save');
    const status = document.getElementById('status-msg');
    const data = {
      date: document.getElementById('addDate').value,
      person: "Ula", // é è¨­äººå
      item: document.getElementById('addItem').value,
      category: document.getElementById('addCategory').value,
      amount: document.getElementById('addAmount').value,
      note: ""
    };

    if(!data.item || !data.amount) { alert("è«‹å¡«å¯«é …ç›®èˆ‡é‡‘é¡"); return; }
    
    btn.disabled = true;
    status.innerText = "ğŸš€ æ­£åœ¨é£›å¾€é›²ç«¯...";

    try {
      await fetch(GAS_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(data)
      });
      status.innerText = "âœ… è¨˜å¥½äº†ï¼";
      document.getElementById('addItem').value = "";
      document.getElementById('addAmount').value = "";
    } catch(e) {
      status.innerText = "âŒ å¤±æ•—äº†ï¼Œè«‹æª¢æŸ¥è¨­å®š";
    } finally {
      btn.disabled = false;
    }
  }
</script>
</body>
</html>
