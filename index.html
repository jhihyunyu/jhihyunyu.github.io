<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>æ­æ´²æ—…éŠåŠ©æ‰‹</title>
  <style>
    :root {
      --primary-pink: #ffb7b2;
      --soft-blue: #b2e2f2;
      --warm-orange: #ffdac1;
      --bg-color: #fffafb;
      --text-gray: #5d5d5d;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; background: var(--bg-color); }
    body { display: flex; flex-direction: column; font-family: -apple-system, "PingFang TC", sans-serif; }

    /* ä¸Šæ–¹å°è¦½åˆ— */
    .nav-header {
      background: #fff;
      padding-top: env(safe-area-inset-top);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 100;
      flex-shrink: 0;
    }
    .tab-bar { display: flex; height: 60px; }
    .tab-item {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 13px; color: #bbb; cursor: pointer; transition: 0.2s; position: relative;
    }
    .tab-item.active { color: var(--primary-pink); font-weight: bold; }
    .tab-item.active::after {
      content: ''; position: absolute; bottom: 0; width: 40%; height: 3px; background: var(--primary-pink); border-radius: 10px;
    }
    .tab-icon { font-size: 20px; margin-bottom: 2px; }

    /* Day åˆ†é å°è¦½åˆ— */
    .day-nav {
      display: flex; gap: 8px; overflow-x: auto; padding: 12px 15px; 
      background: #fff; border-bottom: 1px solid #f0f0f0; flex-shrink: 0;
      scrollbar-width: none;
    }
    .day-nav::-webkit-scrollbar { display: none; }
    .day-btn {
      flex-shrink: 0; padding: 8px 18px; border-radius: 12px; background: #f8f8f8;
      color: #999; font-size: 14px; font-weight: bold; cursor: pointer; border: 1px solid #eee;
    }
    .day-btn.active { background: var(--primary-pink); color: #fff; border-color: var(--primary-pink); box-shadow: 0 4px 10px rgba(255,183,178,0.3); }

    /* å…§å®¹å€ */
    .content-area { flex: 1; position: relative; overflow: hidden; }
    .page {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      overflow-y: auto; padding: 20px; box-sizing: border-box;
      transition: transform 0.3s ease-out; transform: translateX(100%);
    }
    .page.active { transform: translateX(0); }
    .page.prev { transform: translateX(-100%); }

    /* è¡Œç¨‹é¡¯ç¤ºé‚è¼¯ */
    .day-content-group { display: none; }
    .day-content-group.active { display: block; animation: fadeIn 0.3s ease; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* å¡ç‰‡èˆ‡æŒ‰éˆ•æ¨£å¼ */
    .card { background: #fff; border-radius: 20px; padding: 18px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); border: 1px solid rgba(255,183,178,0.1); }
    .itinerary-card { border-left: 5px solid var(--soft-blue); }
    .itinerary-title { font-size: 17px; font-weight: bold; color: var(--text-gray); }
    
    .map-btn { 
      display: inline-flex; align-items: center; 
      background: #f0f7ff; color: #007aff; 
      padding: 10px 16px; border-radius: 12px; 
      font-size: 14px; text-decoration: none; 
      margin-top: 12px; font-weight: bold;
      border: 1px solid rgba(0,122,255,0.1);
    }
    .map-btn:active { background: #e0eeff; }

    /* è¨˜å¸³è¼¸å…¥æ¨£å¼ */
    label { font-size: 13px; color: #999; margin-bottom: 8px; display: block; }
    input, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1.5px solid #f0f0f0; border-radius: 12px; font-size: 16px; background: #fafafa; }
    button.btn-save { background: var(--primary-pink); color: white; border: none; border-radius: 15px; padding: 16px; font-size: 17px; font-weight: bold; width: 100%; box-shadow: 0 4px 0 #ff9aa2; cursor: pointer; }
  </style>
</head>
<body>

  <nav class="nav-header">
    <div class="tab-bar">
      <div class="tab-item active" onclick="switchTab(0)"><span class="tab-icon">âœï¸</span><span>è¨˜å¸³</span></div>
      <div class="tab-item" onclick="switchTab(1)"><span class="tab-icon">ğŸ’°</span><span>ç´€éŒ„</span></div>
      <div class="tab-item" onclick="switchTab(2)"><span class="tab-icon">ğŸ—ºï¸</span><span>è¡Œç¨‹</span></div>
    </div>
  </nav>

  <div class="content-area">
    <div id="page-0" class="page active">
      <div class="card">
        <label>æ—¥æœŸ</label><input type="date" id="addDate">
        <label>ä»˜éŒ¢çš„äºº</label><select id="addPerson"><option>U</option><option>ç³</option><option>é»‘</option><option>ä¸¹</option></select>
        <label>é …ç›®åç¨±</label><input type="text" id="addItem" placeholder="ä¾‹å¦‚ï¼šæ™šé¤">
        <div style="display:flex; gap:12px;">
          <div style="flex:1"><label>åˆ†é¡</label><select id="addCategory"><option>åƒ ğŸ•</option><option>äº¤é€š ğŸ«</option><option>ä½å®¿ ğŸ¨</option><option>è³¼ç‰© ğŸ›ï¸</option></select></div>
          <div style="flex:1"><label>é‡‘é¡</label><input type="number" id="addAmount" placeholder="0.00" inputmode="decimal"></div>
        </div>
        <button class="btn-save" onclick="submitExpense()">å„²å­˜è¨˜å¸³</button>
        <div id="status-msg" style="text-align:center; margin-top:12px; font-size:13px; color:var(--primary-pink);"></div>
      </div>
    </div>

    <div id="page-1" class="page"><div id="history-content">è¼‰å…¥ä¸­...</div></div>

    <div id="page-2" class="page" style="padding: 0; display: flex; flex-direction: column;">
      <div id="day-nav-container" class="day-nav"></div>
      <div id="itinerary-content" style="flex: 1; overflow-y: auto; padding: 20px;">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

<script>
  const SPREADSHEET_ID = "1-bY7b7pZpFN8ANpTkRKSzQ2FARgy0KYPkEMaqU7CVIk";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbwE9dQuZ0TlCyW4d-FaybzNs-muTqUAuBCbML2ETJyurBpGs0yN0JsGPhqaoc8ILCUj/exec"; 

  document.getElementById('addDate').valueAsDate = new Date();

  function switchTab(index) {
    const pages = document.querySelectorAll('.page');
    const tabs = document.querySelectorAll('.tab-item');
    pages.forEach((p, i) => {
      p.classList.remove('active', 'prev');
      if(i === index) p.classList.add('active');
      else if(i < index) p.classList.add('prev');
    });
    tabs.forEach((t, i) => t.classList.toggle('active', i === index));
    if(index === 1) loadData('è¨˜å¸³', renderHistory);
    if(index === 2) loadData('è¡Œç¨‹', renderItinerary);
  }

  async function loadData(sheetName, callback) {
    const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
    try {
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      callback(parseCSV(text));
    } catch (e) { console.error(e); }
  }

  function parseCSV(text) {
    const lines = text.split("\n").filter(l => l.trim());
    if (!lines.length) return [];
    const header = lines[0].split(",").map(h => h.replace(/"/g, "").trim());
    return lines.slice(1).map(line => {
      const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      const obj = {};
      header.forEach((h, i) => obj[h] = cols[i]?.replace(/"/g, "").trim());
      return obj;
    });
  }

  function renderHistory(data) {
    const container = document.getElementById('history-content');
    let total = 0;
    const html = data.reverse().map(r => {
      const amt = parseFloat(r["é‡‘é¡"] || 0);
      total += amt;
      return `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
        <div style="text-align:left"><b>${r["é …ç›®"]}</b> <small style="color:var(--primary-pink)">(${r["äºº"]})</small><br>
        <small style="color:#aaa">${r["æ—¥æœŸ"]}</small></div>
        <div style="font-weight:bold;">$${amt.toFixed(2)}</div>
      </div>`;
    }).join("");
    container.innerHTML = `<div class="card" style="background:var(--warm-orange); color:#fff; text-align:center; border:none;">ç¸½æ”¯å‡º $${total.toFixed(2)}</div>` + html;
  }

  function renderItinerary(data) {
    const container = document.getElementById('itinerary-content');
    const navContainer = document.getElementById('day-nav-container');
    let html = "";
    let navHtml = "";
    let dayGroups = {};

    data.forEach(r => {
      const day = r["Day"] || "Unknown";
      if (!dayGroups[day]) dayGroups[day] = { date: r["æ—¥æœŸ"], items: [] };
      dayGroups[day].items.push(r);
    });

    const dayKeys = Object.keys(dayGroups);
    dayKeys.forEach((day, index) => {
      navHtml += `<button id="btn-${day}" class="day-btn ${index === 0 ? 'active' : ''}" onclick="showDayPage('${day}')">${day}</button>`;
      html += `<div id="content-${day}" class="day-content-group ${index === 0 ? 'active' : ''}">`;
      html += `<div style="color:var(--primary-pink); font-weight:bold; margin-bottom:15px; font-size:14px;">ğŸ“… ${dayGroups[day].date}</div>`;
      
      dayGroups[day].items.forEach(item => {
        // --- ä¿®æ­£å¾Œçš„ Google Map é€£çµé‚è¼¯ ---
        let mapLink = "";
        const mapVal = item["Google map"] ? item["Google map"].trim() : "";
        
        if (mapVal) {
          // å¦‚æœå¡«å¯«çš„æ˜¯ç¶²å€ï¼Œç›´æ¥ç”¨ï¼›å¦‚æœæ˜¯æ–‡å­—ï¼Œç”Ÿæˆæœå°‹ç¶²å€
          if (mapVal.startsWith("http")) {
            mapLink = mapVal;
          } else {
            mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapVal)}`;
          }
        }

        html += `
          <div class="card itinerary-card">
            ${item["æ™‚é–“"] ? `<div style="font-size:12px; color:var(--soft-blue); font-weight:bold;">â° ${item["æ™‚é–“"]}</div>` : ''}
            <div class="itinerary-title">${item["æ¨™é¡Œ"]}</div>
            ${item["å…§å®¹"] ? `<div style="font-size:14px; color:#888; white-space:pre-wrap; margin-top:5px;">${item["å…§å®¹"]}</div>` : ''}
            ${mapLink ? `<a href="${mapLink}" target="_blank" class="map-btn">ğŸ“ å‰å¾€åœ°åœ–</a>` : ''}
          </div>`;
      });
      html += `</div>`;
    });

    navContainer.innerHTML = navHtml;
    container.innerHTML = html || '<div class="card">æš«ç„¡è¡Œç¨‹</div>';
  }

  function showDayPage(dayId) {
    document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${dayId}`).classList.add('active');
    document.querySelectorAll('.day-content-group').forEach(group => group.classList.remove('active'));
    document.getElementById(`content-${dayId}`).classList.add('active');
    document.getElementById('itinerary-content').scrollTop = 0;
  }

  async function submitExpense() {
    const btn = document.querySelector('.btn-save');
    const status = document.getElementById('status-msg');
    const params = new URLSearchParams();
    params.append('date', document.getElementById('addDate').value);
    params.append('person', document.getElementById('addPerson').value);
    params.append('item', document.getElementById('addItem').value);
    params.append('category', document.getElementById('addCategory').value);
    params.append('amount', document.getElementById('addAmount').value);

    btn.disabled = true;
    status.innerText = "ğŸš€ å„²å­˜ä¸­...";
    try {
      await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: params.toString() });
      status.innerText = "âœ… æˆåŠŸï¼";
      setTimeout(() => { status.innerText = ""; switchTab(1); }, 1000);
    } catch(e) { status.innerText = "âŒ å¤±æ•—"; }
    btn.disabled = false;
  }
</script>
</body>
</html>
